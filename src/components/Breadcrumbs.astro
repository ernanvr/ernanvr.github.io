---
import { useTranslations } from "@i18n/ui";
import {
  getLocaleFromPath,
  getLocalizedPath,
  localizePath,
  stripLocaleFromPath,
} from "@i18n/utils";

const locale = getLocaleFromPath(Astro.url.pathname);
const t = useTranslations(locale);

const currentUrlPath = stripLocaleFromPath(Astro.url.pathname).replace(
  /\/+$/,
  ""
);
const breadcrumbList = currentUrlPath.split("/").slice(1);

const segmentLabels: Record<string, string> = {
  posts: t("nav.posts"),
  tags: t("nav.tags"),
  archives: t("nav.archives"),
  search: t("nav.search"),
  about: t("nav.about"),
  "sobre-mi": t("nav.about"),
  now: t("nav.now"),
  ahora: t("nav.now"),
  uses: t("nav.uses"),
  uso: t("nav.uses"),
};

if (breadcrumbList[0] === "posts") {
  breadcrumbList.splice(
    0,
    2,
    `${t("nav.posts")} (${t("breadcrumbs.page")} ${breadcrumbList[1] || 1})`
  );
}

if (breadcrumbList[0] === "tags" && !isNaN(Number(breadcrumbList[2]))) {
  breadcrumbList.splice(
    1,
    3,
    `${breadcrumbList[1]} ${
      Number(breadcrumbList[2]) === 1
        ? ""
        : `(${t("breadcrumbs.page")} ${breadcrumbList[2]})`
    }`
  );
}
---

<nav class="breadcrumb" aria-label="breadcrumb">
  <ul>
    <li>
      <a href={getLocalizedPath(locale, "home")}>{t("breadcrumbs.home")}</a>
      <span aria-hidden="true">&raquo;</span>
    </li>
    {
      breadcrumbList.map((breadcrumb, index) =>
        index + 1 === breadcrumbList.length ? (
          <li>
            <span
              class={`${index > 0 ? "lowercase" : "capitalize"}`}
              aria-current="page"
            >
              {decodeURIComponent(segmentLabels[breadcrumb] ?? breadcrumb)}
            </span>
          </li>
        ) : (
          <li>
            <a
              href={localizePath(
                `/${currentUrlPath
                  .split("/")
                  .filter(Boolean)
                  .slice(0, index + 1)
                  .join("/")}/`,
                locale
              )}
            >
              {decodeURIComponent(segmentLabels[breadcrumb] ?? breadcrumb)}
            </a>
            <span aria-hidden="true">&raquo;</span>
          </li>
        )
      )
    }
  </ul>
</nav>

<style>
  .breadcrumb {
    @apply mx-auto mb-2 mt-8 w-full max-w-3xl px-4;
  }
  .breadcrumb ul {
    @apply inline-flex flex-wrap items-center gap-1 rounded-md border border-skin-line/70 bg-skin-card/65 px-3 py-2 font-mono text-xs;
  }
  .breadcrumb ul li {
    @apply inline;
  }
  .breadcrumb ul li a {
    @apply capitalize text-skin-base/75;
  }
  .breadcrumb ul li span {
    @apply text-skin-base/75;
  }
  .breadcrumb ul li:not(:last-child) a {
    @apply hover:text-skin-accent;
  }
</style>
